# 番茄时钟小程序详细设计文档

## 1. 页面详细设计

### 1.1 主页面（index/index.vue）

#### 1.1.1 页面结构

```vue
<template>
  <view class="timer-page">
    <!-- 顶部任务列表入口 -->
    <view class="header">
      <u-icon name="list" @click="goToTaskList" />
    </view>
    
    <!-- 倒计时显示区域 -->
    <view class="countdown-container">
      <view class="mode-indicator">{{ currentModeText }}</view>
      <view class="countdown-display">
        <text class="time-text">{{ formattedTime }}</text>
      </view>
      <view class="progress-ring">
        <!-- 进度环动画 -->
      </view>
    </view>
    
    <!-- 控制按钮区域 -->
    <view class="control-buttons">
      <u-button v-if="!isRunning" @click="startTimer">开始</u-button>
      <u-button v-if="isRunning" @click="pauseTimer">暂停</u-button>
      <u-button @click="resetTimer">重置</u-button>
    </view>
  </view>
</template>
```

#### 1.1.2 数据定义

```javascript
data() {
  return {
    // 计时器状态
    timer: null,              // 定时器实例
    isRunning: false,         // 是否运行中
    isPaused: false,          // 是否暂停
    remainingTime: 0,         // 剩余时间（秒）
    
    // 模式配置
    currentMode: 'work',      // 当前模式: 'work' | 'rest'
    workDuration: 25 * 60,    // 工作时间：25分钟（秒）
    restDuration: 5 * 60,     // 休息时间：5分钟（秒）
    
    // 循环配置
    enableLoop: true,          // 是否启用循环
    
    // 进度计算
    progress: 0               // 进度百分比 0-100
  }
}
```

#### 1.1.3 核心方法

```javascript
methods: {
  // 开始计时
  startTimer() {
    if (this.isPaused) {
      // 从暂停状态恢复
      this.isPaused = false;
    } else {
      // 初始化时间
      this.remainingTime = this.currentMode === 'work' 
        ? this.workDuration 
        : this.restDuration;
    }
    
    this.isRunning = true;
    this.startCountdown();
  },
  
  // 倒计时逻辑
  startCountdown() {
    this.timer = setInterval(() => {
      if (this.remainingTime > 0) {
        this.remainingTime--;
        this.updateProgress();
      } else {
        this.onTimerComplete();
      }
    }, 1000);
  },
  
  // 暂停计时
  pauseTimer() {
    this.isRunning = false;
    this.isPaused = true;
    this.clearTimer();
  },
  
  // 重置计时
  resetTimer() {
    this.isRunning = false;
    this.isPaused = false;
    this.clearTimer();
    this.remainingTime = this.currentMode === 'work' 
      ? this.workDuration 
      : this.restDuration;
    this.progress = 0;
  },
  
  // 计时完成
  onTimerComplete() {
    this.clearTimer();
    this.isRunning = false;
    this.showCompleteNotification();
    
    // 循环切换模式
    if (this.enableLoop) {
      this.switchMode();
      // 自动开始下一轮
      setTimeout(() => {
        this.startTimer();
      }, 2000);
    }
  },
  
  // 切换模式
  switchMode() {
    this.currentMode = this.currentMode === 'work' ? 'rest' : 'work';
    this.remainingTime = this.currentMode === 'work' 
      ? this.workDuration 
      : this.restDuration;
    this.progress = 0;
  },
  
  // 更新进度
  updateProgress() {
    const total = this.currentMode === 'work' 
      ? this.workDuration 
      : this.restDuration;
    this.progress = ((total - this.remainingTime) / total) * 100;
  },
  
  // 清理定时器
  clearTimer() {
    if (this.timer) {
      clearInterval(this.timer);
      this.timer = null;
    }
  },
  
  // 完成提醒
  showCompleteNotification() {
    uni.showToast({
      title: this.currentMode === 'work' ? '工作完成！休息一下吧' : '休息结束，继续工作',
      icon: 'success',
      duration: 2000
    });
    
    // 震动反馈（如果支持）
    uni.vibrateShort();
  },
  
  // 跳转到任务列表
  goToTaskList() {
    uni.navigateTo({
      url: '/pages/task-list/task-list'
    });
  }
}
```

#### 1.1.4 计算属性

```javascript
computed: {
  // 格式化时间显示
  formattedTime() {
    const minutes = Math.floor(this.remainingTime / 60);
    const seconds = this.remainingTime % 60;
    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
  },
  
  // 当前模式文本
  currentModeText() {
    return this.currentMode === 'work' ? '专注工作' : '短暂休息';
  }
}
```

#### 1.1.5 样式设计

```scss
.timer-page {
  min-height: 100vh;
  background: linear-gradient(135deg, #FF6347 0%, #FF8C69 100%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40rpx;
  
  .header {
    position: absolute;
    top: 40rpx;
    right: 40rpx;
    width: 80rpx;
    height: 80rpx;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    backdrop-filter: blur(10rpx);
    
    .u-icon {
      font-size: 48rpx;
      color: #FFFFFF;
    }
  }
  
  .countdown-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    
    .mode-indicator {
      font-size: 32rpx;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 60rpx;
      font-weight: 500;
    }
    
    .countdown-display {
      position: relative;
      width: 500rpx;
      height: 500rpx;
      display: flex;
      align-items: center;
      justify-content: center;
      
      .time-text {
        font-size: 140rpx;
        font-weight: bold;
        color: #FFFFFF;
        text-shadow: 0 4rpx 20rpx rgba(0, 0, 0, 0.2);
        font-family: 'DIN Alternate', 'Arial', sans-serif;
        letter-spacing: 8rpx;
      }
    }
    
    .progress-ring {
      position: absolute;
      width: 500rpx;
      height: 500rpx;
      border: 8rpx solid rgba(255, 255, 255, 0.3);
      border-top-color: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      animation: rotate 2s linear infinite;
    }
  }
  
  .control-buttons {
    width: 100%;
    display: flex;
    justify-content: center;
    gap: 30rpx;
    margin-top: 80rpx;
    
    .u-button {
      min-width: 200rpx;
      height: 88rpx;
      border-radius: 50rpx;
      background: rgba(255, 255, 255, 0.9);
      color: #FF6347;
      font-size: 32rpx;
      font-weight: 600;
      border: none;
      box-shadow: 0 8rpx 24rpx rgba(0, 0, 0, 0.15);
    }
  }
}

@keyframes rotate {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}
```

### 1.2 任务列表页（task-list/task-list.vue）

#### 1.2.1 页面结构

```vue
<template>
  <view class="task-list-page">
    <!-- 顶部标题栏 -->
    <view class="header">
      <u-icon name="arrow-left" @click="goBack" />
      <text class="title">任务列表</text>
      <view class="placeholder"></view>
    </view>
    
    <!-- 任务列表 -->
    <view class="task-list-container">
      <view 
        v-for="task in taskList" 
        :key="task.id"
        class="task-item"
        @click="goToTaskDetail(task.id)"
      >
        <view class="task-content">
          <view class="task-title">{{ task.title }}</view>
          <view class="task-meta">
            <u-tag 
              :text="getPriorityText(task.priority)" 
              :type="getPriorityType(task.priority)"
              size="mini"
            />
            <u-tag 
              :text="getCategoryText(task.category)" 
              type="info"
              size="mini"
            />
          </view>
        </view>
        <u-icon name="arrow-right" color="#999" />
      </view>
      
      <!-- 空状态 -->
      <u-empty 
        v-if="taskList.length === 0"
        text="暂无任务"
        mode="data"
      />
    </view>
  </view>
</template>
```

#### 1.2.2 数据定义

```javascript
data() {
  return {
    taskList: []  // 任务列表
  }
}
```

#### 1.2.3 核心方法

```javascript
methods: {
  // 加载任务列表
  loadTaskList() {
    try {
      const tasks = uni.getStorageSync('tomato_clock_task_list') || [];
      this.taskList = tasks;
    } catch (e) {
      console.error('加载任务列表失败:', e);
      this.taskList = [];
    }
  },
  
  // 跳转到任务详情
  goToTaskDetail(taskId) {
    uni.navigateTo({
      url: `/pages/task-detail/task-detail?id=${taskId}`
    });
  },
  
  // 返回上一页
  goBack() {
    uni.navigateBack();
  },
  
  // 获取优先级文本
  getPriorityText(priority) {
    const map = {
      'high': '高优先级',
      'medium': '中优先级',
      'low': '低优先级'
    };
    return map[priority] || '未知';
  },
  
  // 获取优先级类型
  getPriorityType(priority) {
    const map = {
      'high': 'error',
      'medium': 'warning',
      'low': 'success'
    };
    return map[priority] || 'info';
  },
  
  // 获取分类文本
  getCategoryText(category) {
    const map = {
      'work': '工作',
      'study': '学习',
      'life': '生活'
    };
    return map[category] || '未知';
  }
}
```

#### 1.2.4 生命周期

```javascript
onLoad() {
  this.loadTaskList();
},

onShow() {
  // 页面显示时重新加载（可能在其他页面有更新）
  this.loadTaskList();
}
```

### 1.3 任务详情页（task-detail/task-detail.vue）

#### 1.3.1 页面结构

```vue
<template>
  <view class="task-detail-page">
    <!-- 顶部标题栏 -->
    <view class="header">
      <u-icon name="arrow-left" @click="goBack" />
      <text class="title">任务详情</text>
      <view class="placeholder"></view>
    </view>
    
    <!-- 任务详情内容 -->
    <view class="detail-container" v-if="task">
      <!-- 任务标题 -->
      <view class="detail-section">
        <view class="section-label">任务标题</view>
        <view class="section-content title-content">{{ task.title }}</view>
      </view>
      
      <!-- 任务描述 -->
      <view class="detail-section">
        <view class="section-label">任务描述</view>
        <view class="section-content desc-content">{{ task.description || '暂无描述' }}</view>
      </view>
      
      <!-- 优先级 -->
      <view class="detail-section">
        <view class="section-label">优先级</view>
        <view class="section-content">
          <u-tag 
            :text="getPriorityText(task.priority)" 
            :type="getPriorityType(task.priority)"
          />
        </view>
      </view>
      
      <!-- 任务分类 -->
      <view class="detail-section">
        <view class="section-label">任务分类</view>
        <view class="section-content">
          <u-tag 
            :text="getCategoryText(task.category)" 
            type="info"
          />
        </view>
      </view>
      
      <!-- 番茄数量 -->
      <view class="detail-section">
        <view class="section-label">番茄数量</view>
        <view class="section-content">
          <view class="tomato-count">
            <u-icon name="star-fill" color="#FF6347" />
            <text class="count-text">{{ task.tomatoCount || 0 }}</text>
          </view>
        </view>
      </view>
    </view>
    
    <!-- 加载中 -->
    <view v-else class="loading">
      <u-loading-icon />
    </view>
  </view>
</template>
```

#### 1.3.2 数据定义

```javascript
data() {
  return {
    taskId: '',
    task: null
  }
}
```

#### 1.3.3 核心方法

```javascript
methods: {
  // 加载任务详情
  loadTaskDetail() {
    try {
      const tasks = uni.getStorageSync('tomato_clock_task_list') || [];
      this.task = tasks.find(t => t.id === this.taskId) || null;
      
      if (!this.task) {
        uni.showToast({
          title: '任务不存在',
          icon: 'none'
        });
        setTimeout(() => {
          this.goBack();
        }, 1500);
      }
    } catch (e) {
      console.error('加载任务详情失败:', e);
      uni.showToast({
        title: '加载失败',
        icon: 'none'
      });
    }
  },
  
  // 返回上一页
  goBack() {
    uni.navigateBack();
  },
  
  // 获取优先级文本（同任务列表页）
  getPriorityText(priority) {
    const map = {
      'high': '高优先级',
      'medium': '中优先级',
      'low': '低优先级'
    };
    return map[priority] || '未知';
  },
  
  // 获取优先级类型（同任务列表页）
  getPriorityType(priority) {
    const map = {
      'high': 'error',
      'medium': 'warning',
      'low': 'success'
    };
    return map[priority] || 'info';
  },
  
  // 获取分类文本（同任务列表页）
  getCategoryText(category) {
    const map = {
      'work': '工作',
      'study': '学习',
      'life': '生活'
    };
    return map[category] || '未知';
  }
}
```

#### 1.3.4 生命周期

```javascript
onLoad(options) {
  if (options.id) {
    this.taskId = options.id;
    this.loadTaskDetail();
  } else {
    uni.showToast({
      title: '参数错误',
      icon: 'none'
    });
    this.goBack();
  }
}
```

## 2. 工具类设计

### 2.1 存储工具类（utils/storage.js）

```javascript
/**
 * 本地存储工具类
 */
class StorageUtil {
  // 存储键名
  static KEYS = {
    TASK_LIST: 'tomato_clock_task_list'
  };
  
  /**
   * 获取任务列表
   */
  static getTaskList() {
    try {
      const data = uni.getStorageSync(this.KEYS.TASK_LIST);
      return data ? JSON.parse(data) : [];
    } catch (e) {
      console.error('获取任务列表失败:', e);
      return [];
    }
  }
  
  /**
   * 保存任务列表
   */
  static saveTaskList(taskList) {
    try {
      uni.setStorageSync(this.KEYS.TASK_LIST, JSON.stringify(taskList));
      return true;
    } catch (e) {
      console.error('保存任务列表失败:', e);
      return false;
    }
  }
  
  /**
   * 获取任务详情
   */
  static getTaskById(id) {
    const taskList = this.getTaskList();
    return taskList.find(task => task.id === id) || null;
  }
  
  /**
   * 添加任务
   */
  static addTask(task) {
    const taskList = this.getTaskList();
    task.id = this.generateId();
    task.createTime = Date.now();
    task.updateTime = Date.now();
    task.tomatoCount = task.tomatoCount || 0;
    taskList.push(task);
    return this.saveTaskList(taskList);
  }
  
  /**
   * 更新任务
   */
  static updateTask(updatedTask) {
    const taskList = this.getTaskList();
    const index = taskList.findIndex(task => task.id === updatedTask.id);
    if (index !== -1) {
      taskList[index] = {
        ...taskList[index],
        ...updatedTask,
        updateTime: Date.now()
      };
      return this.saveTaskList(taskList);
    }
    return false;
  }
  
  /**
   * 删除任务
   */
  static deleteTask(id) {
    const taskList = this.getTaskList();
    const filteredList = taskList.filter(task => task.id !== id);
    return this.saveTaskList(filteredList);
  }
  
  /**
   * 生成唯一ID
   */
  static generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }
}

export default StorageUtil;
```

### 2.2 时间工具类（utils/time.js）

```javascript
/**
 * 时间工具类
 */
class TimeUtil {
  /**
   * 格式化时间（秒 -> MM:SS）
   */
  static formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
  }
  
  /**
   * 格式化时间戳
   */
  static formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day} ${hours}:${minutes}`;
  }
}

export default TimeUtil;
```

## 3. 常量定义

### 3.1 常量文件（constants/index.js）

```javascript
/**
 * 应用常量
 */
export const TASK_PRIORITY = {
  HIGH: 'high',
  MEDIUM: 'medium',
  LOW: 'low'
};

export const TASK_CATEGORY = {
  WORK: 'work',
  STUDY: 'study',
  LIFE: 'life'
};

export const TIMER_MODE = {
  WORK: 'work',
  REST: 'rest'
};

export const TIMER_DURATION = {
  WORK: 25 * 60,    // 25分钟
  REST: 5 * 60      // 5分钟
};

export const PRIORITY_TEXT_MAP = {
  [TASK_PRIORITY.HIGH]: '高优先级',
  [TASK_PRIORITY.MEDIUM]: '中优先级',
  [TASK_PRIORITY.LOW]: '低优先级'
};

export const PRIORITY_TYPE_MAP = {
  [TASK_PRIORITY.HIGH]: 'error',
  [TASK_PRIORITY.MEDIUM]: 'warning',
  [TASK_PRIORITY.LOW]: 'success'
};

export const CATEGORY_TEXT_MAP = {
  [TASK_CATEGORY.WORK]: '工作',
  [TASK_CATEGORY.STUDY]: '学习',
  [TASK_CATEGORY.LIFE]: '生活'
};
```

## 4. 配置文件

### 4.1 pages.json配置

```json
{
  "pages": [
    {
      "path": "pages/index/index",
      "style": {
        "navigationStyle": "custom",
        "navigationBarTextStyle": "white"
      }
    },
    {
      "path": "pages/task-list/task-list",
      "style": {
        "navigationStyle": "custom",
        "navigationBarTitleText": "任务列表"
      }
    },
    {
      "path": "pages/task-detail/task-detail",
      "style": {
        "navigationStyle": "custom",
        "navigationBarTitleText": "任务详情"
      }
    }
  ],
  "globalStyle": {
    "navigationBarTextStyle": "black",
    "navigationBarTitleText": "番茄时钟",
    "navigationBarBackgroundColor": "#FFFFFF",
    "backgroundColor": "#F8F8F8"
  }
}
```

### 4.2 manifest.json配置（关键部分）

```json
{
  "mp-weixin": {
    "appid": "",
    "setting": {
      "urlCheck": false
    },
    "usingComponents": true
  }
}
```

## 5. 测试数据

### 5.1 初始化测试数据

```javascript
// utils/mockData.js
export const mockTasks = [
  {
    id: '1',
    title: '完成项目需求文档',
    description: '编写详细的需求说明书和设计文档',
    priority: 'high',
    category: 'work',
    tomatoCount: 3,
    createTime: Date.now() - 86400000,
    updateTime: Date.now() - 3600000
  },
  {
    id: '2',
    title: '学习Vue3新特性',
    description: '阅读Vue3官方文档，学习Composition API',
    priority: 'medium',
    category: 'study',
    tomatoCount: 2,
    createTime: Date.now() - 172800000,
    updateTime: Date.now() - 7200000
  },
  {
    id: '3',
    title: '整理房间',
    description: '清理书桌，整理衣物',
    priority: 'low',
    category: 'life',
    tomatoCount: 1,
    createTime: Date.now() - 259200000,
    updateTime: Date.now() - 10800000
  }
];
```

## 6. 开发注意事项

### 6.1 Vue2语法要求
- 使用`data()`函数返回数据
- 使用`this.$set`更新响应式数据
- 使用`this.$nextTick`处理DOM更新
- 禁止使用`<script setup>`等Vue3特性

### 6.2 uView图标使用
- 必须使用uView内置图标
- 常用图标：`list`, `arrow-left`, `arrow-right`, `star-fill`
- 参考uView2.0官方文档确认图标名称

### 6.3 图片资源
- 使用Unsplash API获取图片
- API示例：`https://source.unsplash.com/800x600/?tomato,productivity`
- 注意图片加载失败的处理

### 6.4 性能优化
- 定时器及时清理，避免内存泄漏
- 页面隐藏时暂停定时器
- 使用`onUnload`清理资源

### 6.5 兼容性
- 测试不同小程序平台的兼容性
- 注意API差异（如震动反馈）
- 提供降级方案

